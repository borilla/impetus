{"version":3,"file":"impetus.min.js","sources":["../src/impetus.js","../src/is-passive-supported.js"],"sourcesContent":["import isPassiveSupported from \"./is-passive-supported\";\n\nconst doc = document;\n\n// options to send to `addEventListener` to make event passive (ie can't use `preventDefault`)\nconst eventOptionsPassive = isPassiveSupported() ? { passive: true } : false;\n\nexport default class Impetus {\n\tconstructor({\n\t\tsource: sourceEl = document,\n\t\tupdate: updateCallback,\n\t\tmultiplier = 1,\n\t\tpositionX = 0,\n\t\twidth,\n\t}) {\n\t\tvar pointerLastX, pointerCurrentX, pointerId, velocityX;\n\t\tvar ticking = false;\n\t\tvar pointerActive = false;\n\t\tvar trackingPoints = [];\n\n\t\t/**\n\t\t * Initialize instance\n\t\t */\n\t\t(function init() {\n\t\t\tsourceEl = (typeof sourceEl === 'string') ? doc.querySelector(sourceEl) : sourceEl;\n\n\t\t\tif (positionX !== 0) {\n\t\t\t\tcallUpdateCallback();\n\t\t\t}\n\n\t\t\tsourceEl.addEventListener('touchstart', onDown, eventOptionsPassive);\n\t\t\tsourceEl.addEventListener('mousedown', onDown);\n\t\t})();\n\n\t\t/**\n\t\t * In edge cases where you may need to\n\t\t * reinstantiate Impetus on the same sourceEl\n\t\t * this will remove the previous event listeners\n\t\t */\n\t\tthis.destroy = function() {\n\t\t\tsourceEl.removeEventListener('touchstart', onDown);\n\t\t\tsourceEl.removeEventListener('mousedown', onDown);\n\t\t\t// however it won't \"destroy\" a reference\n\t\t\t// to instance if you'd like to do that\n\t\t\t// it returns null as a convenience.\n\t\t\t// ex: `instance = instance.destroy();`\n\t\t\treturn null;\n\t\t};\n\n\t\t/**\n\t\t * Update the current x value\n\t\t * @public\n\t\t * @param {Number} x\n\t\t */\n\t\tthis.setX = function(x) {\n\t\t\tpositionX = x;\n\t\t};\n\n\t\t/**\n\t\t * Update the multiplier value\n\t\t * @public\n\t\t * @param {Number} val\n\t\t */\n\t\tthis.setMultiplier = function(val) {\n\t\t\tmultiplier = val;\n\t\t};\n\n\t\t/**\n\t\t * Executes the update function\n\t\t */\n\t\tfunction callUpdateCallback() {\n\t\t\tupdateCallback.call(sourceEl, positionX);\n\t\t}\n\n\t\t/**\n\t\t * Creates a custom normalized event object from touch and mouse events\n\t\t * @param  {Event} ev\n\t\t * @returns {Object} with x, y, and id properties\n\t\t */\n\t\tfunction normalizeEvent(ev) {\n\t\t\tif (ev.type === 'touchmove' || ev.type === 'touchstart' || ev.type === 'touchend') {\n\t\t\t\tvar touch = ev.targetTouches[0] || ev.changedTouches[0];\n\t\t\t\treturn {\n\t\t\t\t\tx: touch.clientX,\n\t\t\t\t\ty: touch.clientY,\n\t\t\t\t\tid: touch.identifier\n\t\t\t\t};\n\t\t\t} else { // mouse events\n\t\t\t\treturn {\n\t\t\t\t\tx: ev.clientX,\n\t\t\t\t\ty: ev.clientY,\n\t\t\t\t\tid: null\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Initializes movement tracking\n\t\t * @param  {Object} ev event (not yet normalized)\n\t\t */\n\t\tfunction onDown(ev) {\n\t\t\tvar event = normalizeEvent(ev);\n\t\t\tif (!pointerActive) {\n\t\t\t\tpointerActive = true;\n\t\t\t\tpointerId = event.id;\n\n\t\t\t\tpointerLastX = pointerCurrentX = event.x;\n\t\t\t\ttrackingPoints = [];\n\t\t\t\taddTrackingPoint(pointerLastX);\n\n\t\t\t\tconst addDocumentEvent = doc.addEventListener;\n\t\t\t\taddDocumentEvent('touchmove', onMove, eventOptionsPassive);\n\t\t\t\taddDocumentEvent('touchend', onUp);\n\t\t\t\taddDocumentEvent('touchcancel', stopTracking);\n\t\t\t\taddDocumentEvent('mousemove', onMove, eventOptionsPassive);\n\t\t\t\taddDocumentEvent('mouseup', onUp);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Handles move events\n\t\t * @param  {Object} ev Normalized event\n\t\t */\n\t\tfunction onMove(ev) {\n\t\t\tvar event = normalizeEvent(ev);\n\n\t\t\tif (pointerActive && event.id === pointerId) {\n\t\t\t\tpointerCurrentX = event.x;\n\t\t\t\taddTrackingPoint(pointerLastX);\n\t\t\t\trequestTick();\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Handles up/end events\n\t\t * @param {Object} ev Normalized event\n\t\t */\n\t\tfunction onUp(ev) {\n\t\t\tvar event = normalizeEvent(ev);\n\n\t\t\tif (pointerActive && event.id === pointerId) {\n\t\t\t\tstopTracking();\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Stops movement tracking, starts animation\n\t\t */\n\t\tfunction stopTracking() {\n\t\t\tpointerActive = false;\n\t\t\taddTrackingPoint(pointerLastX);\n\t\t\tstartDecelAnim();\n\n\t\t\tconst removeDocumentEvent = doc.removeEventListener;\n\t\t\tremoveDocumentEvent('touchmove', onMove);\n\t\t\tremoveDocumentEvent('touchend', onUp);\n\t\t\tremoveDocumentEvent('touchcancel', stopTracking);\n\t\t\tremoveDocumentEvent('mouseup', onUp);\n\t\t\tremoveDocumentEvent('mousemove', onMove);\n\t\t}\n\n\t\t/**\n\t\t * Records movement for the last 100ms\n\t\t * @param {number} x\n\t\t */\n\t\tfunction addTrackingPoint(x) {\n\t\t\tvar time = Date.now();\n\t\t\twhile (trackingPoints.length > 0) {\n\t\t\t\tif (time - trackingPoints[0].time <= 100) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\ttrackingPoints.shift();\n\t\t\t}\n\n\t\t\ttrackingPoints.push({x, time});\n\t\t}\n\n\t\t/**\n\t\t * Calculate new values, call update function\n\t\t */\n\t\tfunction updateAndRender() {\n\t\t\tvar pointerChangeX = pointerCurrentX - pointerLastX;\n\n\t\t\tpositionX += pointerChangeX * multiplier;\n\n\t\t\tcallUpdateCallback();\n\n\t\t\tpointerLastX = pointerCurrentX;\n\t\t\tticking = false;\n\t\t}\n\n\t\t/**\n\t\t * prevents animating faster than current framerate\n\t\t */\n\t\tfunction requestTick() {\n\t\t\tif (!ticking) {\n\t\t\t\trequestAnimationFrame(updateAndRender);\n\t\t\t}\n\t\t\tticking = true;\n\t\t}\n\n\t\t/**\n\t\t * Initialize animation of values coming to a stop\n\t\t */\n\t\tfunction startDecelAnim() {\n\t\t\tvar firstPoint = trackingPoints[0];\n\t\t\tvar lastPoint = trackingPoints[trackingPoints.length - 1];\n\n\t\t\tvar xOffset = lastPoint.x - firstPoint.x;\n\t\t\tvar timeOffset = lastPoint.time - firstPoint.time;\n\n\t\t\tvar D = (timeOffset / 15) / multiplier;\n\n\t\t\tvelocityX = (xOffset / D) || 0; // prevent NaN\n\n\t\t\trequestAnimationFrame(stepDecelAnim);\n\t\t}\n\n\t\t/**\n\t\t * Consider effect of two closest attractors to given position\n\t\t */\n\t\tfunction considerAttractors(position, velocity) {\n\t\t\tconst ACCELERATION = 3;\n\t\t\tconst SLOWING_FACTOR = 0.92;\n\t\t\tconst SPEED_THRESHOLD = 0.04 * width;\n\t\t\tconst DISTANCE_THRESHOLD = SPEED_THRESHOLD;\n\n\t\t\t// approximate mid-position for animation step\n\t\t\tconst midPosition = position + velocity / 2;\n\n\t\t\t// positions of previous and next attractors\n\t\t\tconst attractor0 = Math.floor(midPosition / width) * width;\n\t\t\tconst attractor1 = attractor0 + width;\n\n\t\t\t// distances to previous and next attractors\n\t\t\tconst distance0 = midPosition - attractor0;\n\t\t\tconst distance1 = width - distance0;\n\n\t\t\t// calculate new velocity and position\n\t\t\tvelocityX += (distance0 - distance1) / width * ACCELERATION;\n\t\t\tvelocityX *= SLOWING_FACTOR;\n\t\t\tpositionX += velocityX;\n\n\t\t\t// are we close enough to an attractor and going slowly enough?\n\t\t\tif (velocity > -SPEED_THRESHOLD && positionX < attractor0 + DISTANCE_THRESHOLD) {\n\t\t\t\tvelocityX = 0;\n\t\t\t\tpositionX = attractor0;\n\t\t\t\tcallUpdateCallback();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// else\n\t\t\tif (velocity < SPEED_THRESHOLD && positionX > attractor1 - DISTANCE_THRESHOLD) {\n\t\t\t\tvelocityX = 0;\n\t\t\t\tpositionX = attractor1;\n\t\t\t\tcallUpdateCallback();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcallUpdateCallback();\n\t\t\trequestAnimationFrame(stepDecelAnim);\n\t\t}\n\n\t\t/**\n\t\t * Animates values slowing down\n\t\t */\n\t\tfunction stepDecelAnim() {\n\t\t\tconsiderAttractors(positionX, velocityX);\n\t\t}\n\t}\n}\n","export default function isPassiveSupported() {\n\tlet _isPassiveSupported = false;\n\n\ttry {\n\t\tconst name = 'test';\n\t\tconst noop = () => {};\n\t\tconst options = Object.defineProperty({}, 'passive', {\n\t\t\tget: () => {\n\t\t\t\t_isPassiveSupported = true;\n\t\t\t}\n\t\t});\n\n\t\taddEventListener(name, noop, options);\n\t\tremoveEventListener(name, noop);\n\t} catch (err) {}\n\n\treturn _isPassiveSupported;\n}\n"],"names":["doc","document","eventOptionsPassive","_isPassiveSupported","noop","options","Object","defineProperty","err","isPassiveSupported","passive","callUpdateCallback","call","sourceEl","positionX","normalizeEvent","ev","type","touch","targetTouches","changedTouches","clientX","clientY","identifier","onDown","event","pointerActive","id","pointerCurrentX","x","pointerLastX","addDocumentEvent","addEventListener","onMove","onUp","stopTracking","pointerId","ticking","updateAndRender","firstPoint","trackingPoints","lastPoint","length","xOffset","timeOffset","time","multiplier","stepDecelAnim","removeDocumentEvent","removeEventListener","addTrackingPoint","Date","now","shift","push","position","velocity","SPEED_THRESHOLD","width","DISTANCE_THRESHOLD","midPosition","attractor0","Math","floor","attractor1","distance0","velocityX","source","updateCallback","update","querySelector","destroy","setX","setMultiplier","val"],"mappings":"uLAEMA,EAAMC,SAGNC,ICLS,eACVC,GAAsB,UAInBC,EAAO,aACPC,EAAUC,OAAOC,kBAAmB,eACpC,cACkB,sBAJX,OAQUH,EAAMC,uBARhB,OASaD,GACzB,MAAOI,WAEFL,EDXoBM,KAAyBC,SAAS,UAG7D,uBA8DUC,MACOC,KAAKC,EAAUC,YAQtBC,EAAeC,MACP,cAAZA,EAAGC,MAAoC,eAAZD,EAAGC,MAAqC,aAAZD,EAAGC,KAAqB,KAC9EC,EAAQF,EAAGG,cAAc,IAAMH,EAAGI,eAAe,YAEjDF,EAAMG,UACNH,EAAMI,WACLJ,EAAMK,qBAIPP,EAAGK,UACHL,EAAGM,WACF,eASEE,EAAOR,OACXS,EAAQV,EAAeC,OACtBU,EAAe,IACH,IACJD,EAAME,KAEHC,EAAkBH,EAAMI,SAEtBC,OAEXC,EAAmB/B,EAAIgC,mBACZ,YAAaC,EAAQ/B,KACrB,WAAYgC,KACZ,cAAeC,KACf,YAAaF,EAAQ/B,KACrB,UAAWgC,aAQrBD,EAAOjB,OACXS,EAAQV,EAAeC,GAEvBU,GAAiBD,EAAME,KAAOS,MACfX,EAAMI,IACPC,GAmEbO,yBACkBC,MAEb,YA7DFJ,EAAKlB,OACTS,EAAQV,EAAeC,GAEvBU,GAAiBD,EAAME,KAAOS,gBAQ1BD,OACQ,IACCL,kBAuDbS,EAAaC,EAAe,GAC5BC,EAAYD,EAAeA,EAAeE,OAAS,GAEnDC,EAAUF,EAAUZ,EAAIU,EAAWV,EACnCe,EAAaH,EAAUI,KAAON,EAAWM,OAIhCF,GAFJC,EAAa,GAAME,IAEC,wBAEPC,UA9DhBC,EAAsBhD,EAAIiD,sBACZ,YAAahB,KACb,WAAYC,KACZ,cAAeC,KACf,UAAWD,KACX,YAAaD,YAOzBiB,EAAiBrB,WACrBgB,EAAOM,KAAKC,MACTZ,EAAeE,OAAS,KAC1BG,EAAOL,EAAe,GAAGK,MAAQ,QAGtBQ,UAGDC,MAAMzB,IAAGgB,kBAMhBP,QACaV,EAAkBE,GAETgB,QAIflB,KACL,WA6EFmB,cA5CmBQ,EAAUC,OAG/BC,EAAkB,IAAOC,EACzBC,EAAqBF,EAGrBG,EAsCa9C,EAtCY0C,EAAW,EAGpCK,EAAaC,KAAKC,MAAMH,EAAcF,GAASA,EAC/CM,EAAaH,EAAaH,EAG1BO,EAAYL,EAAcC,MAIlBI,GAHIP,EAAQO,IAGaP,EAjBlB,QACE,IAqBnBF,GAAYC,GAAmB3C,EAAY+C,EAAaF,KAC/C,IACAE,OAKTL,EAAWC,GAAmB3C,EAAYkD,EAAaL,KAC9C,IACAK,kCAMSjB,KAOHjC,EAAWoD,WAjQ/BC,OAAQtD,aAAWZ,WACXmE,IAARC,WACAvB,WAAAA,aAAa,QACbhC,UAAAA,aAAY,IACZ4C,IAAAA,8GAEI5B,EAAcF,EAAiBQ,EAAW8B,EAC1C7B,GAAU,EACVX,GAAgB,EAChBc,OAM6B,iBAAb3B,EAAyBb,EAAIsE,cAAczD,GAAYA,EAExD,IAAdC,SAIKkB,iBAAiB,aAAcR,EAAQtB,KACvC8B,iBAAiB,YAAaR,QAQnC+C,QAAU,oBACLtB,oBAAoB,aAAczB,KAClCyB,oBAAoB,YAAazB,GAKnC,WAQHgD,KAAO,SAAS3C,KACRA,QAQR4C,cAAgB,SAASC,KAChBA"}