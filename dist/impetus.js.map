{"version":3,"file":"impetus.js","sources":["../src/is-passive-supported.js","../src/impetus.js"],"sourcesContent":["export default function isPassiveSupported() {\n\tlet _isPassiveSupported = false;\n\n\ttry {\n\t\tconst name = 'test';\n\t\tconst noop = () => {};\n\t\tconst options = Object.defineProperty({}, 'passive', {\n\t\t\tget: () => {\n\t\t\t\t_isPassiveSupported = true;\n\t\t\t}\n\t\t});\n\n\t\taddEventListener(name, noop, options);\n\t\tremoveEventListener(name, noop);\n\t} catch (err) {}\n\n\treturn _isPassiveSupported;\n}\n","import isPassiveSupported from \"./is-passive-supported\";\n\nconst doc = document;\n\n// options to send to `addEventListener` to make event passive (ie can't use `preventDefault`)\nconst eventOptionsPassive = isPassiveSupported() ? { passive: true } : false;\n\nexport default class Impetus {\n\tconstructor({\n\t\tsource: sourceEl = document,\n\t\tupdate: updateCallback,\n\t\tmultiplier = 1,\n\t\tpositionX = 0,\n\t\twidth,\n\t}) {\n\t\tvar pointerLastX, pointerCurrentX, pointerId, velocityX;\n\t\tvar ticking = false;\n\t\tvar pointerActive = false;\n\t\tvar trackingPoints = [];\n\n\t\t/**\n\t\t * Initialize instance\n\t\t */\n\t\t(function init() {\n\t\t\tsourceEl = (typeof sourceEl === 'string') ? doc.querySelector(sourceEl) : sourceEl;\n\n\t\t\tif (positionX !== 0) {\n\t\t\t\tcallUpdateCallback();\n\t\t\t}\n\n\t\t\tsourceEl.addEventListener('touchstart', onDown, eventOptionsPassive);\n\t\t\tsourceEl.addEventListener('mousedown', onDown);\n\t\t})();\n\n\t\t/**\n\t\t * In edge cases where you may need to\n\t\t * reinstantiate Impetus on the same sourceEl\n\t\t * this will remove the previous event listeners\n\t\t */\n\t\tthis.destroy = function() {\n\t\t\tsourceEl.removeEventListener('touchstart', onDown);\n\t\t\tsourceEl.removeEventListener('mousedown', onDown);\n\t\t\t// however it won't \"destroy\" a reference\n\t\t\t// to instance if you'd like to do that\n\t\t\t// it returns null as a convenience.\n\t\t\t// ex: `instance = instance.destroy();`\n\t\t\treturn null;\n\t\t};\n\n\t\t/**\n\t\t * Update the current x value\n\t\t * @public\n\t\t * @param {Number} x\n\t\t */\n\t\tthis.setX = function(x) {\n\t\t\tpositionX = x;\n\t\t};\n\n\t\t/**\n\t\t * Update the multiplier value\n\t\t * @public\n\t\t * @param {Number} val\n\t\t */\n\t\tthis.setMultiplier = function(val) {\n\t\t\tmultiplier = val;\n\t\t};\n\n\t\t/**\n\t\t * Executes the update function\n\t\t */\n\t\tfunction callUpdateCallback() {\n\t\t\tupdateCallback.call(sourceEl, positionX);\n\t\t}\n\n\t\t/**\n\t\t * Creates a custom normalized event object from touch and mouse events\n\t\t * @param  {Event} ev\n\t\t * @returns {Object} with x, y, and id properties\n\t\t */\n\t\tfunction normalizeEvent(ev) {\n\t\t\tif (ev.type === 'touchmove' || ev.type === 'touchstart' || ev.type === 'touchend') {\n\t\t\t\tvar touch = ev.targetTouches[0] || ev.changedTouches[0];\n\t\t\t\treturn {\n\t\t\t\t\tx: touch.clientX,\n\t\t\t\t\ty: touch.clientY,\n\t\t\t\t\tid: touch.identifier\n\t\t\t\t};\n\t\t\t} else { // mouse events\n\t\t\t\treturn {\n\t\t\t\t\tx: ev.clientX,\n\t\t\t\t\ty: ev.clientY,\n\t\t\t\t\tid: null\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Initializes movement tracking\n\t\t * @param  {Object} ev event (not yet normalized)\n\t\t */\n\t\tfunction onDown(ev) {\n\t\t\tvar event = normalizeEvent(ev);\n\t\t\tif (!pointerActive) {\n\t\t\t\tpointerActive = true;\n\t\t\t\tpointerId = event.id;\n\n\t\t\t\tpointerLastX = pointerCurrentX = event.x;\n\t\t\t\ttrackingPoints = [];\n\t\t\t\taddTrackingPoint(pointerLastX);\n\n\t\t\t\tconst addDocumentEvent = doc.addEventListener;\n\t\t\t\taddDocumentEvent('touchmove', onMove, eventOptionsPassive);\n\t\t\t\taddDocumentEvent('touchend', onUp);\n\t\t\t\taddDocumentEvent('touchcancel', stopTracking);\n\t\t\t\taddDocumentEvent('mousemove', onMove, eventOptionsPassive);\n\t\t\t\taddDocumentEvent('mouseup', onUp);\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Handles move events\n\t\t * @param  {Object} ev Normalized event\n\t\t */\n\t\tfunction onMove(ev) {\n\t\t\tvar event = normalizeEvent(ev);\n\n\t\t\tif (pointerActive && event.id === pointerId) {\n\t\t\t\tpointerCurrentX = event.x;\n\t\t\t\taddTrackingPoint(pointerLastX);\n\t\t\t\trequestTick();\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Handles up/end events\n\t\t * @param {Object} ev Normalized event\n\t\t */\n\t\tfunction onUp(ev) {\n\t\t\tvar event = normalizeEvent(ev);\n\n\t\t\tif (pointerActive && event.id === pointerId) {\n\t\t\t\tstopTracking();\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Stops movement tracking, starts animation\n\t\t */\n\t\tfunction stopTracking() {\n\t\t\tpointerActive = false;\n\t\t\taddTrackingPoint(pointerLastX);\n\t\t\tstartDecelAnim();\n\n\t\t\tconst removeDocumentEvent = doc.removeEventListener;\n\t\t\tremoveDocumentEvent('touchmove', onMove);\n\t\t\tremoveDocumentEvent('touchend', onUp);\n\t\t\tremoveDocumentEvent('touchcancel', stopTracking);\n\t\t\tremoveDocumentEvent('mouseup', onUp);\n\t\t\tremoveDocumentEvent('mousemove', onMove);\n\t\t}\n\n\t\t/**\n\t\t * Records movement for the last 100ms\n\t\t * @param {number} x\n\t\t */\n\t\tfunction addTrackingPoint(x) {\n\t\t\tvar time = Date.now();\n\t\t\twhile (trackingPoints.length > 0) {\n\t\t\t\tif (time - trackingPoints[0].time <= 100) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\ttrackingPoints.shift();\n\t\t\t}\n\n\t\t\ttrackingPoints.push({x, time});\n\t\t}\n\n\t\t/**\n\t\t * Calculate new values, call update function\n\t\t */\n\t\tfunction updateAndRender() {\n\t\t\tvar pointerChangeX = pointerCurrentX - pointerLastX;\n\n\t\t\tpositionX += pointerChangeX * multiplier;\n\n\t\t\tcallUpdateCallback();\n\n\t\t\tpointerLastX = pointerCurrentX;\n\t\t\tticking = false;\n\t\t}\n\n\t\t/**\n\t\t * prevents animating faster than current framerate\n\t\t */\n\t\tfunction requestTick() {\n\t\t\tif (!ticking) {\n\t\t\t\trequestAnimationFrame(updateAndRender);\n\t\t\t}\n\t\t\tticking = true;\n\t\t}\n\n\t\t/**\n\t\t * Initialize animation of values coming to a stop\n\t\t */\n\t\tfunction startDecelAnim() {\n\t\t\tvar firstPoint = trackingPoints[0];\n\t\t\tvar lastPoint = trackingPoints[trackingPoints.length - 1];\n\n\t\t\tvar xOffset = lastPoint.x - firstPoint.x;\n\t\t\tvar timeOffset = lastPoint.time - firstPoint.time;\n\n\t\t\tvar D = (timeOffset / 15) / multiplier;\n\n\t\t\tvelocityX = (xOffset / D) || 0; // prevent NaN\n\n\t\t\trequestAnimationFrame(stepDecelAnim);\n\t\t}\n\n\t\t/**\n\t\t * Consider effect of two closest attractors to given position\n\t\t */\n\t\tfunction considerAttractors(position, velocity) {\n\t\t\tconst ACCELERATION = 3;\n\t\t\tconst SLOWING_FACTOR = 0.92;\n\t\t\tconst SPEED_THRESHOLD = 0.04 * width;\n\t\t\tconst DISTANCE_THRESHOLD = SPEED_THRESHOLD;\n\n\t\t\t// approximate mid-position for animation step\n\t\t\tconst midPosition = position + velocity / 2;\n\n\t\t\t// positions of previous and next attractors\n\t\t\tconst attractor0 = Math.floor(midPosition / width) * width;\n\t\t\tconst attractor1 = attractor0 + width;\n\n\t\t\t// distances to previous and next attractors\n\t\t\tconst distance0 = midPosition - attractor0;\n\t\t\tconst distance1 = width - distance0;\n\n\t\t\t// calculate new velocity and position\n\t\t\tvelocityX += (distance0 - distance1) / width * ACCELERATION;\n\t\t\tvelocityX *= SLOWING_FACTOR;\n\t\t\tpositionX += velocityX;\n\n\t\t\t// are we close enough to an attractor and going slowly enough?\n\t\t\tif (velocity > -SPEED_THRESHOLD && positionX < attractor0 + DISTANCE_THRESHOLD) {\n\t\t\t\tvelocityX = 0;\n\t\t\t\tpositionX = attractor0;\n\t\t\t\tcallUpdateCallback();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// else\n\t\t\tif (velocity < SPEED_THRESHOLD && positionX > attractor1 - DISTANCE_THRESHOLD) {\n\t\t\t\tvelocityX = 0;\n\t\t\t\tpositionX = attractor1;\n\t\t\t\tcallUpdateCallback();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcallUpdateCallback();\n\t\t\trequestAnimationFrame(stepDecelAnim);\n\t\t}\n\n\t\t/**\n\t\t * Animates values slowing down\n\t\t */\n\t\tfunction stepDecelAnim() {\n\t\t\tconsiderAttractors(positionX, velocityX);\n\t\t}\n\t}\n}\n"],"names":["isPassiveSupported","_isPassiveSupported","name","noop","options","Object","defineProperty","err","doc","document","eventOptionsPassive","passive","Impetus","source","sourceEl","updateCallback","update","multiplier","positionX","width","pointerLastX","pointerCurrentX","pointerId","velocityX","ticking","pointerActive","trackingPoints","init","querySelector","addEventListener","onDown","destroy","removeEventListener","setX","x","setMultiplier","val","callUpdateCallback","call","normalizeEvent","ev","type","touch","targetTouches","changedTouches","clientX","clientY","identifier","event","id","addDocumentEvent","onMove","onUp","stopTracking","removeDocumentEvent","addTrackingPoint","time","Date","now","length","shift","push","updateAndRender","pointerChangeX","requestTick","startDecelAnim","firstPoint","lastPoint","xOffset","timeOffset","D","stepDecelAnim","considerAttractors","position","velocity","ACCELERATION","SLOWING_FACTOR","SPEED_THRESHOLD","DISTANCE_THRESHOLD","midPosition","attractor0","Math","floor","attractor1","distance0","distance1"],"mappings":"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"}